run_quantreg_analysis <- function(file_path) {
  suppressMessages({
    library(readxl)
    library(quantreg)
  })
  
  # -----------------------------
  # Загрузка данных
  # -----------------------------
  df <- suppressMessages(read_excel(file_path))
  # Преобразуем числовые переменные
  df$Score <- as.numeric(gsub(",", ".", as.character(df$Score)))
  df$Hours <- as.numeric(gsub(",", ".", as.character(df$Hours)))
  df$Exp <- as.numeric(gsub(",", ".", as.character(df$Exp)))
  df$InClub <- factor(df$InClub)
  df$HasPortfolio <- factor(df$HasPortfolio)
  df$Awarded <- factor(df$Awarded)
  df <- df[c("Score","Hours","Exp","InClub","HasPortfolio","Awarded")]
  names(df) <- c("Y","Hours","Exp","InClub","HasPortfolio","Awarded")
  
  # -----------------------------
  # 1) Квантильная регрессия
  # -----------------------------
  taus <- 1:9 / 10
  myqreg <- rq(Y ~ Hours + Exp + InClub + HasPortfolio + Awarded, tau=taus, data=df)
  
  cat("=== 1: Квантильная регрессия построена ===\n")
  cat("Используемые tau:", paste(taus, collapse=", "), "\n\n")
  
  # -----------------------------
  # 2) Визуализация
  # -----------------------------
  cat("=== 2: Графики коэффициентов по всем tau ===\n")
  par(mfrow=c(2,3))
  suppressWarnings(plot(myqreg))
  suppressWarnings(plot(summary(myqreg, se="boot")))
  cat("Графики построены (коэффициенты и доверительные интервалы).\n\n")
  
  #Сплошная красная линия это коэффициент линейной регрессии (МНК), а
  #пунктирные красные линии границы доверительных интервалов для
  #коэффициентов линейной регрессии
  
  #Если линия коэффициента растёт с увеличением tau, значит переменная
  #сильнее влияет на верхние квантиле зависимой переменной (Score).
  #Если линия падает, значит переменная сильнее влияет на нижние квантиле.
  #Горизонтальная линия ≈ 0 → слабое влияние на соответствующие квантильные уровни.
  
  #Если линия растёт → переменная усиливает результат на соответствующих квантилях.
  #Если падает → переменная ослабляет результат на этих квантилях.
  #Если линия пересекает 0 → на этих квантилях влияние переменной не значимо.

  #По переменным:
  #1) Intercept (константа)
  #Линия растёт с увеличением tau.
  #Это означает, что сильные студенты имеют намного выше базовый результат, чем слабые.
  #2) Hours
  #Линия сначала почти горизонтальная, потом слегка падает.
  #То есть для самых сильных студентов больше часов может не давать улучшения результата.
  #3) Exp (опыт)
  #Линия сначала растёт, потом падает, затем снова слегка растёт.
  #Опыт положительно влияет на слабые и средние уровни Score, но для верхних квантилей эффект снижается.
  #4) InClub (участие в клубе)
  #Линия растёт почти линейно, особенно на верхних квантилях.
  #Участие в клубе практически не влияет на низкие результаты, но сильно повышает Score у студентов с высокими результатами.
  #5) HasPortfolio
  #Линия падает в середине распределения, затем немного растёт.
  #Наличие портфолио уменьшает Score у студентов со средними результатами, а для слабых и сильных студентов влияние минимальное.
  #Возможно, портфолио не помогает тем, кто либо плохо, либо очень хорошо справляется с основной программой.
  #6) Awarded
  #Линия сначала растёт, затем падает.
  #Награды положительно влияют на средние и верхние квантильные уровни, но эффект снижается для самых сильных.
  #То есть награды полезны для мотивации большинства студентов, но для лидеров дополнительного эффекта почти нет.
  
  # -----------------------------
  # 3) Сравнение медианной регрессии с OLS
  # -----------------------------
  lm_mod <- suppressWarnings(lm(Y ~ Hours + Exp + InClub + HasPortfolio + Awarded, data=df))
  cat("=== 3.1: Линейная регрессия (OLS) ===\n")
  print(summary(lm_mod))
  cat("\n")
  
  median_rq <- rq(Y ~ Hours + Exp + InClub + HasPortfolio + Awarded, data=df, tau=0.5)
  coef_comparison <- data.frame(
    term = names(coef(lm_mod)),
    OLS = as.numeric(coef(lm_mod)),
    MedianRQ = as.numeric(coef(median_rq))
  )
  
  X <- model.matrix(Y ~ Hours + Exp + InClub + HasPortfolio + Awarded, data=df)
  rmse <- function(a,b) sqrt(mean((a-b)^2))
  rmse_ols <- rmse(df$Y, predict(lm_mod))
  rmse_median <- rmse(df$Y, X %*% coef(median_rq))
  
  cat("=== 3.2: Сравнение медианной регрессии с OLS ===\n")
  cat("Таблица коэффициентов:\n")
  print(coef_comparison)
  cat(sprintf("\nRMSE OLS = %.4f; RMSE MedianRQ = %.4f\n", rmse_ols, rmse_median))
  
  # Возвращаем результаты в список
  invisible(list(
    coef_comparison = coef_comparison,
    RMSE = c(OLS = rmse_ols, MedianRQ = rmse_median),
    quantreg_model = myqreg,
    ols_model = lm_mod,
    median_rq_model = median_rq
  ))
  #Multiple R-squared = 0.4165 → модель объясняет ~42% вариации Score.
  #F-statistic = 113.9, p < 2.2e-16 → модель значима в целом.
  #Residual standard error ≈ 7574 → среднеквадратичная ошибка остатков.
  #OLS показывает средний эффект каждой переменной на Score. Все переменные значимы.
  
  #Медианная регрессия:
  #Cхожа с OLS, но показывает влияние на медианный уровень Score, а не среднее.
  
  #RMSE (среднеквадратичная ошибка):
  #OLS: 7546 → медианный эффект более точно отражает средние значения.
  #MedianRQ: 8481 → медианная регрессия хуже предсказывает весь набор данных по RMSE, но точнее отражает центральные значения распределения.
  
  #OLS даёт общий средний эффект, чувствителен к выбросам.
  #MedianRQ показывает влияние на медиану, менее чувствительна к экстремальным значениям.
  #Различия в коэффициентах показывают неоднородное влияние переменных:
  #некоторые переменные сильнее влияют на верхние или нижние уровни Score,
  #чем на медиану.
}

run_quantreg_analysis("dataset2.xls")
